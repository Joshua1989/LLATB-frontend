<!DOCTYPE html>
<html>
<title>LLSIF-AutoTeamBuilder EN</title>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<!-- Load static resources -->
{% load staticfiles %}
<!-- Link W3.CSS -->
<link rel='stylesheet' href="{% static 'css/w3.css' %}">
<!-- Link JQuery -->
<script src="{% static 'js/jquery-3.2.1.min.js' %}"></script>
<!-- Load live basic data -->
<script type="text/javascript" src="{% static 'live_data_base.json' %}"></script>
<script type="text/javascript" src="{% static 'sm_song_list.json' %}"></script>
<!-- Swiper CSS -->
<link rel='stylesheet' href="{% static 'css/swiper.min.css' %}">
<!-- Swiper JS -->
<script src="{% static 'js/swiper.min.js' %}"></script>
<!-- Link LESS CSS -->
<link rel="stylesheet/less" type="text/css" href="{% static 'css/build_team.less' %}" />
<!-- Link LESS JS -->
<script src="{% static 'js/less.min.js' %}"></script>
<!-- Link High Charts -->
<script src="{% static 'js/highstock.js' %}"></script>
<!-- Link SImulation -->
<script src="{% static 'js/simulation.js' %}"></script>

<head>
    <script>
    (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-103167041-2', 'auto');
    ga('send', 'pageview');
    </script>
</head>

<body>
    <div class='w3-container w3-black' style='padding:0'>
        <div id='infoBox' class='infoBar w3-pale-green'>
            <span onclick="this.parentElement.style.display='none'" class='exitBtn'><b>x</b></span>
            <button onclick="document.getElementById('about').style.display='block'" class='aboutBtn'>
                <b>About</b>
            </button>
            <span> </span>
        </div>
        <div class='w3-bar toolBar'>
            <!-- <div class='w3-bar w3-border w3-topbar w3-bottombar w3-border-white' style='padding:12px 0'> -->
            <!-- Group select button -->
            <button id='group' class='groupBtn w3-margin-left w3-margin-right' onclick="switchGroup()"></button>
            <!-- Attribute select radio buttons -->
            <button id='attrSmile' class='attrBtn' onclick="switchColor('Smile')"></button>
            <button id='attrPure' class='attrBtn' onclick="switchColor('Pure')"></button>
            <button id='attrCool' class='attrBtn' onclick="switchColor('Cool')"></button>
            <!-- Difficulty select dropdown -->
            <div id='difficulty' class='w3-dropdown-click w3-margin-left'>
                <button class='diffBtn'></button>
                <div class='w3-dropdown-content w3-bar-block' style='z-index:2;min-width:40px;background-color:rgba(0,0,0,0);'>
                </div>
            </div>
            <button id='scoreUp' class='imgBtn w3-margin-left' onclick="toggleScoreUp()"></button>
            <button id='skillUp' class='imgBtn' onclick="toggleSkillUp()"></button>
            <div class="w3-bar-item w3-margin-left" style='width:75px;height:40px;padding:0;'>
                <input id='perfectRate' class='w3-input w3-round-large' type='number' min='0.01' max='1' step='0.01' placeholder='Perfect Rate' required='required' onchange="changePerfectRate()">
            </div>
            <button id='unlimitGem' class='imgBtn w3-margin-left w3-margin-right' onclick="toggleUnlimitGem()"></button>
            <select id='extraCond' class='w3-bar-item w3-select w3-margin-right' style='height:40px;padding:0' onchange="changeExtraCondition()">
            </select>
            </select>
            <button class='w3-bar-item w3-pink w3-hover-yellow roundBtn w3-margin-right' style='padding:0 0' onclick="openUserJSON()"><b>User JSON</b></button>
            <select id='guestCenter' class='w3-bar-item w3-select w3-mobile' style='height:40px;padding:0' onchange="changeGuestCenter()">
            </select>
            <button id='calculate' class='w3-bar-item w3-pink w3-hover-yellow roundBtn w3-margin-left w3-right w3-mobile' onclick="calculate()"><b>Calculate</b></button>
        </div>
        <div id='liveSel' class='infoBar w3-black' style='height:auto'>
            <span> <b> </b> </span>
        </div>
        <!-- Swiper -->
        <div id='liveSwiper' class='swiper-container w3-black'>
            <div class='swiper-wrapper'>
                <div class='swiper-slide'><b>Init</b></div>
            </div>
        </div>
    </div>
    <div id="simulation" class='w3-display-container'>
        <span class='exitBtn' style='z-index:1'><b>x</b></span>
        <div id="cover_rate">
        </div>
        <div id="simul_hist">
        </div>
        <div id="simul_result">
        </div>
    </div>
    <div id='result'>
    </div>
    <div id='userJSON' class='w3-modal'>
        <div class='w3-modal-content' style='height:100%'>
            <div class='w3-container w3-black w3-padding-24' style='height:100%;overflow: scroll;'>
                <span class='exitBtn'><b>x</b></span>
                <span id='profile-title'><b>User Profile JSON:</b></span>
                <a href='/edit_profile/en' style="text-decoration:none">
                    <button class='roundBtn w3-pink w3-hover-yellow w3-margin-left'><b>Manual</b></button>
                </a>
                <button id='importSIT' class='roundBtn w3-pink w3-hover-yellow w3-margin-left'><b>Import SIT</b></button>
                <textarea class='w3-round-large profile w3-input w3-margin-top' required='required'></textarea>
                <div class='output'>
                    <b>LL Helper Team sd file</b>
                    <textarea class='w3-round-large LLH w3-input' readonly></textarea>
                </div>
                <div class='output'>
                    <b>SIFStats Team JSON</b>
                    <textarea class='w3-round-large ieb w3-input' readonly></textarea>
                </div>
            </div>
        </div>
    </div>
    <div id='liveStats' class='w3-modal'>
        <div class='w3-modal-content'>
            <div class='w3-container w3-padding-24 w3-border w3-topbar w3-bottombar w3-leftbar w3-rightbar w3-border-blue'>
            </div>
        </div>
    </div>
    <div id='modalSIT' class='w3-modal'>
        <div class='w3-modal-content'>
            <div class='w3-container w3-black w3-padding-24 w3-border w3-topbar w3-bottombar w3-leftbar w3-rightbar w3-border-blue'>
                <span class='exitBtn'><b>x</b></span>
                <p class='w3-mobile'><b>SIT User Name</b></p>
                <div class='w3-bar'>
                    <input class='w3-input w3-round-large'>
                </div>
                <p class='w3-mobile'><b>Select Account</b></p>
                <div class='w3-bar w3-margin-buttom'>
                    <select class='w3-select'>
                    </select>
                </div>
                <div class='w3-display-container' style='margin-top:40px'>
                    <button class='roundBtn w3-pink w3-hover-yellow w3-display-middle w3-mobile' style='width:20%'><b>Import</b></button>
                </div>
            </div>
        </div>
    </div>
    <div id='modalLocal' class='w3-modal'>
        <div class='w3-modal-content'>
            <div class='w3-container w3-black w3-padding-24 w3-border w3-topbar w3-bottombar w3-leftbar w3-rightbar w3-border-blue'>
                <span class='exitBtn'><b>x</b></span>
                <p class='w3-mobile'><b>Select Local Account</b></p>
                <div class='w3-bar w3-margin-buttom'>
                    <select class='w3-select'>
                    </select>
                </div>
                <div class='w3-display-container' style='margin-top:40px'>
                    <button class='import roundBtn w3-pink w3-hover-yellow w3-left' style='padding:0;min-width:70px;'><b>Import</b></button>
                    <button class='save roundBtn w3-pink w3-hover-yellow w3-margin-left' style='min-width:70px;'><b>Save</b></button>
                    <button class='create roundBtn w3-pink w3-hover-yellow w3-right' style='min-width:70px;'><b>Create</b></button>
                </div>
            </div>
        </div>
    </div>
    <div id='about' class='w3-modal'>
        <div class='w3-modal-content'>
            <div class='w3-container w3-padding-24'>
                <p style='text-align:left'>
                    <span onclick="document.getElementById('about').style.display='none'" class='exitBtn'><b>x</b></span>
                    <img src='//pic.xiami.net/images/avatar_new/49/2486368_1419132611.jpeg@1e_1c_0i_1o_100Q_200w.jpg' height=60 style='display:inline;vertical-align: middle;'> Nyan~ Welcome to the web LLSIF-AutoTeamBuilder, now it has formed {{ count }} teams for SIF players.
                    <br/>
                    <br/> For efficiency and stability, Web LLSIF-AutoTeamBuilder uses the following parameters:
                    <br/> Set all kiss gems to 9, the candidate card pond has size 12, 1-suboptimal DP algorithm is applied when the gem is limited, while 1-suboptimal DC is applied when the gem is unlimited.
                    <br/> Under above assumption
                    <span style='color:red'>optimal solution is not GUARANTEED</span>，but by experience most of the case the expected total score is within 1000 points to the optimal one.
                    <br/> You can run a more accurate algorithm locally by using
                    <a href='//github.com/Joshua1989/LLSIF-AutoTeamBuilder'><b>Github source</b></a>，more detail for the algorithm please refer to <a href='../../doc'><b>Love Live SIF: Introduction to team strength</b></a> (written in Chinese).
                    <br/>
                    <br/> User Guide: <a href='../../tutorial/en'><b>detailed tutorial here</b></a>
                    <ol>
                        <li>Choose song (Click on song name to add to live list, click cover to look at live details), and extra conditions</li>
                        <li> If you are using a third-party proxy <a href='//stats.llsif.win/' style='color:blue'><b>SIFStats (JP)</b></a>, <a href='http://pll.sokka.cn/user' style='color:blue'><b>LLproxy (CN)</b></a>, then you can directly copy the user profile JSON to input your card list.
                            <br/> If you have used <a href="https://designedfor.sakura.ne.jp/nikuma-n/" style='color:blue'><b>minaraishi's team builder</b></a>, you can copy the exported file here.
                            <br/> If you have a <a href="http://schoolido.lu/" style='color:blue'><b>School Idol Tomodachi</b></a> account, you can also import your user profile here.
                            <br/> If you are in EN server or not linked to any proxy stats site, you can edit your profile <span style='color:red'><b>manually</b></span>, once you are done I highly recommend you to <span style='color:red'><b>save the JSON locally</b></span> in case of lost.
                            <br/> The input user JSON is stored in local storage, so next time you open this page you do not need to copy your JSON again.
                        </li>
                        <li>Click calculate button to solve for optimal team and gem allocation.</li>
                    </ol>
                    To check the best SIS allocation and team strength details for user custom teams, check <a href='../../team_strength'><b style='color:red'>team strength page</b></a>.
                    <br/> If you found a bug, please <a href="https://www.reddit.com/user/Hentyclopedia/"><b>report it to me</b></a>, please describe the situation with <span style='color:red'>ALL SETTINGS</span>.
                    <br/>
                </p>
            </div>
        </div>
    </div>
    <script>
    // utility for string format
    String.prototype.format = function() {
        a = this;
        for (k in arguments) {
            a = a.replace('{' + k + '}', arguments[k]);
        }
        return a;
    }
    // utility for check whether a string is a valid JSON
    function IsJsonString(str) {
        try {
            JSON.parse(str);
        } catch (e) {
            return false;
        }
        return true;
    }

    window.ondragstart = function() { return false; }

    // Load all live basic information
    var live_info = JSON.parse(live_info_data),
        sm_info = JSON.parse(sm_songs);
    var img_url = {
        muse: '//r.llsif.win/assets/image/event/mission/ms_m_type_10.png',
        Aqours: '//r.llsif.win/assets/image/event/mission/ms_m_type_11.png',
        Smile: '//db.loveliv.es/static/img/icon/1.png',
        Pure: '//db.loveliv.es/static/img/icon/2.png',
        Cool: '//db.loveliv.es/static/img/icon/3.png',
        Easy: '//r.llsif.win/assets/image/ui/event/e_button_12.png',
        Normal: '//r.llsif.win/assets/image/ui/event/e_button_13.png',
        Hard: '//r.llsif.win/assets/image/ui/event/e_button_14.png',
        Expert: '//r.llsif.win/assets/image/ui/event/e_button_15.png',
        Master: '//r.llsif.win/assets/image/ui/event/e_button_17.png',
        ScoreUp: '//r.llsif.win/assets/image/ui/event/e_button_32.png',
        SkillUp: '//r.llsif.win/assets/image/ui/event/e_button_33.png',
        UnlimitGem: '//r.llsif.win/assets/flash/ui/live/img/e_icon_07.png',
    };
    var default_cover_url = {
        muse: {
            Smile: '//r.llsif.win/assets/image/ui/live/l_etc_36.png',
            Pure: '//r.llsif.win/assets/image/ui/live/l_etc_37.png',
            Cool: '//r.llsif.win/assets/image/ui/live/l_etc_38.png',
        },
        Aqours: {
            Smile: '//r.llsif.win/assets/image/ui/live/l_etc_130.png',
            Pure: '//r.llsif.win/assets/image/ui/live/l_etc_131.png',
            Cool: '//r.llsif.win/assets/image/ui/live/l_etc_132.png',
        }
    }
    var group_arr = {
        muse: 'μ\'s',
        Aqours: 'Aqours'
    };
    var attribute_arr = ['Smile', 'Pure', 'Cool'];
    var attribute_color = {
        Smile: 'red',
        Pure: 'green',
        Cool: 'blue'
    }
    var attribute_color2 = {
        Smile: '\#f44336',
        Pure: '\#4CAF50',
        Cool: '\#2196F3'
    }
    var difficulty_arr = ['Easy', 'Normal', 'Hard', 'Expert', 'Master'];
    var extra_cond_arr = ['default', 'current_max', 'idolized_max', 'ultimate'];
    var extra_cond_text = {
        default: 'Maintain Current',
        current_max: 'Max Lv & Bond',
        idolized_max: 'Idlz, Max Lv & Bond',
        ultimate: 'Idlz, Lv 8 & Slot Max'
    };
    var main_C_info = { false: 12, true: 9 }
    var vice_C_info = {
        "μ\'s": 3,
        'Aqours': 3,
        '1st-year': 6,
        '2nd-year': 6,
        '3rd-year': 6,
        'Printemps': 6,
        'lily white': 6,
        'BiBi': 6,
        'CYaRon！': 6,
        'AZALEA': 6,
        'Guilty Kiss': 6
    }

    // Initialize selections
    var group_sel = 'muse',
        attr_sel = 'Smile',
        diff_sel = 'Expert',
        score_up = false,
        skill_up = false,
        unlimit_gem = false,
        perfect_rate = 0.95,
        extra_cond = 'default',
        guest_center = 'None';
    var user_json = localStorage.getItem("user_json");
    var user_json_bucket = localStorage.getItem("user_json_bucket");
    var default_user_json = '{"unit_info":[],"deck_info":[],"removable_info":{"equipment_info":{},"owning_info":[{"total_amount":9,"unit_removable_skill_id":1},{"total_amount":9,"unit_removable_skill_id":2},{"total_amount":9,"unit_removable_skill_id":3},{"total_amount":9,"unit_removable_skill_id":4},{"total_amount":9,"unit_removable_skill_id":5},{"total_amount":9,"unit_removable_skill_id":6},{"total_amount":9,"unit_removable_skill_id":7},{"total_amount":9,"unit_removable_skill_id":8},{"total_amount":9,"unit_removable_skill_id":9},{"total_amount":9,"unit_removable_skill_id":10},{"total_amount":9,"unit_removable_skill_id":11},{"total_amount":9,"unit_removable_skill_id":12},{"total_amount":9,"unit_removable_skill_id":13},{"total_amount":9,"unit_removable_skill_id":14},{"total_amount":9,"unit_removable_skill_id":15},{"total_amount":9,"unit_removable_skill_id":16},{"total_amount":9,"unit_removable_skill_id":17},{"total_amount":9,"unit_removable_skill_id":18},{"total_amount":9,"unit_removable_skill_id":19},{"total_amount":9,"unit_removable_skill_id":20},{"total_amount":9,"unit_removable_skill_id":21},{"total_amount":9,"unit_removable_skill_id":22},{"total_amount":9,"unit_removable_skill_id":23},{"total_amount":9,"unit_removable_skill_id":24},{"total_amount":9,"unit_removable_skill_id":25},{"total_amount":9,"unit_removable_skill_id":26},{"total_amount":9,"unit_removable_skill_id":27},{"total_amount":9,"unit_removable_skill_id":28},{"total_amount":9,"unit_removable_skill_id":29},{"total_amount":9,"unit_removable_skill_id":30},{"total_amount":9,"unit_removable_skill_id":31},{"total_amount":9,"unit_removable_skill_id":32},{"total_amount":9,"unit_removable_skill_id":33},{"total_amount":9,"unit_removable_skill_id":34},{"total_amount":9,"unit_removable_skill_id":35},{"total_amount":9,"unit_removable_skill_id":36},{"total_amount":9,"unit_removable_skill_id":37},{"total_amount":9,"unit_removable_skill_id":38},{"total_amount":9,"unit_removable_skill_id":39}]}}';
    if (user_json == null) {
        user_json = default_user_json;
        localStorage.setItem("user_json", user_json)
    }
    if (user_json_bucket == null | !IsJsonString(user_json_bucket)) {
        user_json_bucket = { 'auto save': default_user_json };
        localStorage.setItem("user_json_bucket", user_json_bucket);
    } else {
        user_json_bucket = JSON.parse(user_json_bucket);
    }
    var song_name = 'Default {0} {1}'.format(group_arr[group_sel], attr_sel);
    var live_selection = {
        group: group_sel,
        attr: attr_sel,
        diff: diff_sel,
        song_list: [song_name],
        is_sm: false,
        is_random: false
    }

    // Used for update MF selection
    function updateLiveSel(add_song) {
        var change = (live_selection['group'] != group_sel) | (live_selection['attr'] != attr_sel) | (live_selection['diff'] != diff_sel)
        if (change) {
            live_selection = {
                group: group_sel,
                attr: attr_sel,
                diff: diff_sel,
                song_list: ['Default {0} {1}'.format(group_arr[group_sel], attr_sel)]
            };
        } else if (add_song) {
            if (live_selection['song_list'].length < 5) {
                if (add_song.indexOf('Default') == -1 && add_song.indexOf('SM') == -1) {
                    if ((live_selection['song_list'].length == 1 && live_selection['song_list'][0].indexOf('默认') > -1) || live_selection.is_sm) {
                        live_selection['song_list'] = [add_song];
                        live_selection.is_sm = false;
                        live_selection.is_random = false;
                    } else {
                        live_selection['song_list'].push(add_song);
                    }
                } else if (add_song.indexOf('Default') > -1) {
                    live_selection = {
                        group: group_sel,
                        attr: attr_sel,
                        diff: diff_sel,
                        song_list: [add_song],
                        is_sm: false,
                        is_random: false
                    };
                } else {
                    var server = sm_info[add_song.slice(3,5)],
                        stg_idx = parseInt(add_song[6])-1;
                    live_selection = {
                        group: group_sel,
                        attr: attr_sel,
                        diff: diff_sel,
                        song_list: server.stages[stg_idx].song_list[attr_sel],
                        is_sm: true,
                        is_random: add_song.indexOf('RND') > -1
                    };
                }
            } else {
                updateInfo('Selected Live number reached upper bound 5', true);
            }
        }
        var song_names = live_selection.is_sm ? add_song : live_selection['song_list'].join(', ')
        $("#liveSel span b").html('Difficulty: {0}, Selected songs: {1}'.format(live_selection['diff'], song_names));
        $("#liveSel span b").css('color', attribute_color2[live_selection['attr']]);
    }
    updateLiveSel();

    // Initialized display
    $('#group').html("<img src='{0}' alt='{1}'>".format(img_url[group_sel], group_arr[group_sel]));
    for (x in attribute_arr) {
        attr = attribute_arr[x];
        $('#attr' + attr).html("<img src='{0}' alt='{1}'>".format(img_url[attr], group_arr[attr]));
        $('#attr' + attr + ' img').addClass('w3-grayscale-max');
    }
    $('#attr' + attr_sel + ' img').removeClass('w3-grayscale-max');
    var temp = '';
    for (x in difficulty_arr) {
        diff = difficulty_arr[x];
        temp += "<button class='w3-bar-item diffItem' onclick=\"switchDifficulty('{0}')\" style='height:40px;padding:0;'><img src='{1}'></button>".format(diff, img_url[diff]);
    }
    $('#difficulty div').html(temp);
    $('#difficulty>button').html("<img src='{0}' height=100%>".format(img_url[diff_sel]));
    $('#scoreUp').html("<img src='{0}' height=100%>".format(img_url['ScoreUp']));
    $('#scoreUp img').addClass('w3-grayscale-max');
    $('#skillUp').html("<img src='{0}' height=100%>".format(img_url['SkillUp']));
    $('#skillUp img').addClass('w3-grayscale-max');
    $('#unlimitGem').html("<img src='{0}' height=100%>".format(img_url['UnlimitGem']));
    $('#unlimitGem img').addClass('w3-grayscale-max');
    $('#perfectRate').val(perfect_rate);
    temp = '';
    for (x in extra_cond_arr) {
        ec = extra_cond_arr[x]
        temp += "<option value='{0}'>{1}</option>".format(ec, extra_cond_text[ec]);
    }
    $('#extraCond').html(temp);
    $('#userJSON .profile').val(user_json);
    $('#simulation').hide();

    // Initialize Swiper
    var swiper = new Swiper('.swiper-container', {
        effect: 'coverflow',
        grabCursor: true,
        centeredSlides: true,
        slidesPerView: 'auto',
        coverflow: {
            rotate: 30,
            stretch: 0,
            depth: 350,
            modifier: 1,
            slideShadows: false
        },
        loop: false,
        mousewheelControl: true,
        freeMode: true,
        freeModeSticky: true
    });
    // Fill live pond into swiper
    function updateLiveSwiper() {
        swiper.removeAllSlides()
        // Default live
        var default_name = 'Default {0} {1}'.format(group_arr[group_sel], attr_sel);
        var color_str = attribute_color[attr_sel];
        swiper.appendSlide("<div class='swiper-slide w3-{0} w3-border-{5} w3-hover-border-yellow'><div class='topBar w3-hover-{6} w3-{0}' onclick=\"chooseLive('{3}','{4}')\"><b class='titleText'>{1}</b></div><img src='{2}'></div>\n".format(color_str, default_name, default_cover_url[group_sel][attr_sel], default_name.replace("'", "\\\'"), diff_sel, color_str, color_str));
        // SM live
        if (diff_sel != 'Master') {
            var date = new Date();
            var date_UTC = new Date(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate(), date.getUTCHours(), date.getUTCMinutes(), date.getUTCSeconds());
            date_UTC = Date.parse(date_UTC);
            for (var server_name in sm_info) {
                var server = sm_info[server_name];
                if (server.group == group_sel) {
                    for (var stg_idx in server.stages) {
                        var stage = server.stages[stg_idx];
                        if (date_UTC >= Date.parse(stage.start) && date_UTC < Date.parse(stage.end)) {
                            var sm_name = 'SM {2} {3}: {0} {1}'.format(group_arr[group_sel], attr_sel, server_name, parseInt(stg_idx) + 1);
                            var song_list = stage.song_list[attr_sel];
                            swiper.appendSlide("<div class='swiper-slide w3-{0} w3-border-{5} w3-hover-border-yellow'><div class='topBar w3-hover-{6} w3-{0}' onclick=\"chooseLive('{3}','{4}')\"><b class='titleText'>{1}</b></div><img src='{2}'></div>\n".format(color_str, sm_name, default_cover_url[group_sel][attr_sel], sm_name.replace("'", "\\\'"), diff_sel, color_str, color_str));
                            // Random songs
                            if (diff_sel == 'Expert') {
                                sm_name = 'SM {2} {3} RND: {0} {1}'.format(group_arr[group_sel], attr_sel, server_name, parseInt(stg_idx) + 1);
                                swiper.appendSlide("<div class='swiper-slide w3-{0} w3-border-{5} w3-hover-border-yellow'><div class='topBar w3-hover-{6} w3-{0}' onclick=\"chooseLive('{3}','{4}')\"><b class='titleText'>{1}</b></div><img src='{2}'></div>\n".format(color_str, sm_name, default_cover_url[group_sel][attr_sel], sm_name.replace("'", "\\\'"), diff_sel, color_str, color_str));
                            }
                        }
                    }
                }
            }
        }
        // Normal live
        for (x in live_info) {
            live = live_info[x];
            if (live['group'] == group_arr[group_sel] && live['attr'] == attr_sel && live['diff_level'] == diff_sel) {
                swiper.appendSlide("<div class='swiper-slide w3-{0} w3-border-{5} w3-hover-border-yellow'><div class='topBar w3-hover-{6} w3-{0}' onclick=\"chooseLive('{3}','{4}')\"><b class='titleText'>{1}</b></div><img src='{2}'></div>\n".format(color_str, live['name'], live['cover'], live['name'], diff_sel, color_str, color_str));
            }
        }
        // Timeout count for onHold event to view live stats
        $('.swiper-slide img').on('click', function(e) {
            viewLiveStats(e);
        });
    }
    updateLiveSwiper();

    function updateGuestCenter() {
        guest_center = 'None'
        temp = "<option disabled style='color:black;'><b>Choose Guest Center Skill</b></option>";
        temp += "<option value='None'>No Guest Center Skill</option>";
        for (x in attribute_arr) {
            var main_attr = attr_sel,
                base_attr = attribute_arr[x];
            var main_ratio = main_C_info[main_attr == base_attr];
            for (y in vice_C_info) {
                var bonus_range = y,
                    bonus_ratio = vice_C_info[y];
                var cskill_str = "{0}: {1} {2}% / {3} {4}%".format(main_attr, base_attr, main_ratio, bonus_range, bonus_ratio);
                temp += "<option value=\"{0}\">{1}</option>".format(cskill_str, cskill_str);
            }
        }
        $('#guestCenter').html(temp);
    }
    updateGuestCenter();

    function viewLiveStats(e) {
        sn = e.target.parentNode.childNodes[0].getElementsByTagName("b")[0].innerHTML;
        if (sn.indexOf('Default') != -1) {
            return
        } else if (sn.indexOf('SM') != -1) {
            $('#liveStats').show();
            $('body').addClass('modal-open');

            var server = sm_info[sn.slice(3, 5)],
                stg_idx = parseInt(sn[6])-1;
            var songs = server.stages[stg_idx].song_list[attr_sel];
            var start = server.stages[stg_idx].start,
                end = server.stages[stg_idx].end;
            temp = '<span onclick="closeLiveStats()" class="exitBtn"><b>x</b></span>'
            temp += "<p align='center' style='color:{0};'>{1}</p>".format(attribute_color[attr_sel], sn);
            temp += "<p align='center' style='color:{0};'>{1}</p>".format(attribute_color[attr_sel], 'From {0} to {1}'.format(start, end));
            temp += "<p align='center' style='color:{0};'>{1}</p>".format(attribute_color[attr_sel], songs.join('<br/>'));
            $('#liveStats .w3-container').html(temp);
        } else {
            POST_JSON = {
                lang: 'EN',
                song_name: sn,
                difficulty: diff_sel,
                perfect_rate: perfect_rate,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            }
            $.ajax({
                type: "POST",
                url: "live_stats",
                headers: {
                    'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
                },
                data: POST_JSON,
                success: function(data) {
                    updateInfo(data['msg'], !data['complete']);
                    $('#result').html(data['result']);
                    $('#liveStats').show();
                    $('body').addClass('modal-open');
                    temp = '<span onclick="closeLiveStats()" class="exitBtn"><b>x</b></span>'
                    temp += data['live_stats'];
                    $('#liveStats .w3-container').html(temp)
                }
            });
        }
    }

    function closeLiveStats() {
        $('#liveStats').hide();
        $('body').removeClass('modal-open')
    }

    // Make a clickable dropdown for difficulty
    $(document).ready(function() {
        $('#difficulty').click(function() {
            $('#difficulty div').show();
        });
        $('#difficulty div').click(function(e) {
            e.stopPropagation();
        });
        $('#difficulty div').mouseleave(function() {
            $('#difficulty div').hide();
        });
    });

    // Update info bar
    function updateInfo(msg, is_error) {
        $("#infoBox").removeClass('w3-pale-green');
        $("#infoBox").removeClass('w3-pale-red');
        if (is_error) {
            $("#infoBox").addClass('w3-pale-red');
        } else {
            $("#infoBox").addClass('w3-pale-green');

        }
        prefix = is_error ? 'ERROR - ' : 'INFO - '
        $("#infoBox span:last").html(prefix + msg);
    }

    // Toggle Muse and Aquors
    function switchGroup() {
        group_sel = group_sel == 'Aqours' ? 'muse' : 'Aqours';
        $('#group').html("<img src='{0}' alt='{1}'>".format(img_url[group_sel], group_arr[group_sel]));
        updateLiveSwiper();
        updateInfo('Choose group as {0}'.format(group_arr[group_sel]), false);
        updateLiveSel();
    }

    // Choose attribute of live
    function switchColor(attr) {
        for (x in attribute_arr) {
            $('#attr' + attribute_arr[x] + ' img').addClass('w3-grayscale-max');
        }
        $('#attr' + attr + ' img').removeClass('w3-grayscale-max');
        attr_sel = attr;
        updateLiveSwiper();
        updateInfo('Choose attribute as {0}'.format(attr_sel), false);
        updateLiveSel();
        updateGuestCenter();
    }

    // Choose difficulty of live
    function switchDifficulty(diff) {
        $('#difficulty div').hide();
        diff_sel = diff;
        updateLiveSwiper();
        updateInfo('Choose difficulty as {0}'.format(diff_sel), false);
        $('#difficulty>button').html("<img src='{0}'>".format(img_url[diff_sel]));
        updateLiveSel();
    }

    // Choose live
    function chooseLive(name, diff) {
        song_name = name;
        updateInfo('Choose song as {0} {1}'.format(name, diff), false);
        updateLiveSel(song_name);
    }

    // Toggle score up, skill up and unlimited gem
    function toggleScoreUp() {
        score_up = !score_up;
        if (score_up) {
            $('#scoreUp img').removeClass('w3-grayscale-max');
        } else {
            $('#scoreUp img').addClass('w3-grayscale-max');
        }
        updateInfo('Score Up 10% {0}'.format(score_up ? 'ON' : 'OFF'), false);
    }

    function toggleSkillUp() {
        skill_up = !skill_up;
        if (skill_up) {
            $('#skillUp img').removeClass('w3-grayscale-max');
        } else {
            $('#skillUp img').addClass('w3-grayscale-max');
        }
        updateInfo('Skill Up 10% {0}'.format(skill_up ? 'ON' : 'OFF'), false);
    }

    function toggleUnlimitGem() {
        unlimit_gem = !unlimit_gem;
        if (unlimit_gem) {
            $('#unlimitGem img').removeClass('w3-grayscale-max');
        } else {
            $('#unlimitGem img').addClass('w3-grayscale-max');
        }
        updateInfo('Unlimited gem {0}'.format(unlimit_gem ? 'ON' : 'OFF'), false);
    }

    // Change perfect rate and extra condition
    function changePerfectRate() {
        temp = parseFloat($('#perfectRate').val());
        if (!isNaN(temp) && temp >= 0.01 && temp <= 1) {
            perfect_rate = temp;
            updateInfo('Change prior perfect rate to {0}%'.format(parseInt(perfect_rate * 100)), false);
        } else {
            $('#perfectRate').val(perfect_rate);
            updateInfo('Invalid prior perfect rate, return to {0}%'.format(parseInt(perfect_rate * 100)), true);
        }

    }

    function changeExtraCondition() {
        extra_cond = $('#extraCond').val();
        updateInfo('Set extra condition as {0}'.format(extra_cond_text[extra_cond]), false);
    }

    function changeGuestCenter() {
        guest_center = $('#guestCenter').val();
        updateInfo('Set guest center as {0}'.format($('#guestCenter').val()), false);
    }

    // Check whether input user JSON is valid
    function openUserJSON() {
        $('#userJSON').show();
        $('body').addClass('modal-open')
    }

    function inputUserJSON() {
        $('body').removeClass('modal-open')
        temp = $('#userJSON .profile').val();
        if (temp == '' || IsJsonString(temp)) {
            if (user_json != temp) {
                user_json_obj = JSON.parse(temp);
                json_valid = user_json_obj['unit_info'] != undefined & user_json_obj['deck_info'] != undefined & user_json_obj['removable_info'] != undefined
                if (json_valid) {
                    json_valid = user_json_obj['removable_info']['equipment_info'] != undefined & user_json_obj['removable_info']['owning_info'] != undefined
                }
                minaraishi_valid = user_json_obj['idol_skills'] != undefined & user_json_obj['members'] != undefined
                if (!json_valid & !minaraishi_valid) {
                    $('#userJSON .profile').val(user_json);
                    updateInfo('Invalid user profile JSON, rollback to last valid version.', true);
                    return false
                } else if (json_valid) {
                    user_json_obj['removable_info']['equipment_info'] = {};
                    user_json_obj['deck_info'] = [];
                    user_json = JSON.stringify(user_json_obj);

                    localStorage.setItem('user_json', user_json);
                    $('#userJSON .profile').val(user_json);
                    user_json_bucket['auto save'] = user_json;
                    localStorage.setItem('user_json_bucket', JSON.stringify(user_json_bucket));
                    updateInfo('User profile JSON successfully updated', false);
                    return true;
                } else if (minaraishi_valid) {
                    POST_JSON = {
                        lang: 'EN',
                        minaraishi_json: temp,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    }
                    $.ajax({
                        type: "POST",
                        url: "minaraishi_convert",
                        headers: {
                            'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
                        },
                        data: POST_JSON,
                        success: function(data) {
                            if (data['complete']) {
                                user_json = data['user_json'];
                                localStorage.setItem('user_json', user_json);
                                $('#userJSON .profile').val(user_json);

                                user_json_bucket['auto save'] = user_json;
                                localStorage.setItem('user_json_bucket', JSON.stringify(user_json_bucket));
                            }
                            updateInfo(data['msg'], !data['complete']);
                            return data['complete']
                        }
                    });
                }
            }
        } else {
            $('#userJSON .profile').val(user_json);
            updateInfo('Input is not valid JSON format, rollback to last valid version.', true);
            return false;
        }
    }

    $('#userJSON .exitBtn').click(function() {
        inputUserJSON();
        $('#userJSON').hide();
    })

    // calculate best team
    function calculate() {
        user_json = localStorage.getItem('user_json');
        if (user_json == '' | user_json == undefined) {
            updateInfo('User profile JSON is empty', true);
            return
        }
        user_json_obj = JSON.parse(user_json)
        if (user_json_obj['unit_info'] == undefined |
            user_json_obj['deck_info'] == undefined |
            user_json_obj['removable_info'] == undefined |
            user_json_obj['removable_info']['equipment_info'] == undefined |
            user_json_obj['removable_info']['owning_info'] == undefined) {
            updateInfo('Invalid user profile JSON', true);
            return
        }
        if (user_json_obj['unit_info'].length < 13) {
            updateInfo('You need at least 13 cards, now you have {0}, please edit your profile.'.format(user_json_obj['unit_info'].length), true);
            return
        }
        $('#calculate').prop('disabled', true);
        $('#calculate').removeClass('w3-pink');
        $('#calculate').addClass('w3-grey');
        $('#calculate b').text('Running');
        var i = 0;
        var running = setInterval(function() {
            i = ++i % 4;
            $("#calculate b").html("Running" + Array(i + 1).join("."));
        }, 500);

        POST_JSON = {
            lang: 'EN',
            song_list: JSON.stringify(live_selection['song_list']),
            group: live_selection['group'],
            attribute: live_selection['attr'],
            difficulty: live_selection['diff'],
            guest_center: guest_center,
            score_up: score_up,
            skill_up: skill_up,
            perfect_rate: perfect_rate,
            unlimit_gem: unlimit_gem,
            extra_cond: extra_cond,
            user_profile: user_json,
            is_sm: live_selection.is_sm,
            is_random: live_selection.is_random,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }
        $.ajax({
            type: "POST",
            url: "calculate",
            headers: {
                'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
            },
            data: POST_JSON,
            success: function(data) {
                if (data['complete']) {
                    $('#simulation').hide();
                    $('#result').html(data['result']);
                    if (live_selection['song_list'][0].indexOf('Default') == -1 && !live_selection.is_sm) {
                        $('#result th').first().html("<button id='simulBtn' class='roundBtn w3-pink w3-hover-yellow' style='white-space: normal;'><b>Simulate</b></button>")
                        setInterval(function() { $("#simulBtn").fadeTo('slow', 0.5).fadeTo('slow', 1); }, 2000);
                        var n_trial = 5000,
                            P_rate = parseFloat(perfect_rate),
                            live_group = group_arr[live_selection['group']],
                            live_attr = live_selection['attr'],
                            simul_card_info = JSON.parse(data.simul_base_info),
                            simul_live_info = JSON.parse(data.note_list),
                            skillup = 1 + 0.1 * skill_up,
                            scoreup = 1 + 0.1 * score_up;
                        $('#simulBtn').click(function() {
                            var simul_res = MonteCarlo(n_trial, P_rate, live_group, live_attr, simul_card_info, simul_live_info, skillup, scoreup);
                            draw_simul('simul_hist', 'cover_rate', simul_res);
                            $('#simulation').show()
                            $('#simul_hist').highcharts().reflow();
                            $('#cover_rate').highcharts().reflow();
                            show_simul_result('simul_result', simul_res, simul_card_info.icon_url);
                            updateInfo('Finished simulation', false);
                        })
                    } else {
                        $('#simulation').hide();
                    }
                    $('#userJSON .LLH').val(data['sd_file']);
                    $('#userJSON .ieb').val(data['ieb_file']);
                }
                updateInfo(data['msg'], !data['complete']);
                $('#calculate').prop('disabled', false);
                $('#calculate').removeClass('w3-grey');
                $('#calculate').addClass('w3-pink');
                clearInterval(running);                
                $('#calculate b').text('Calculate');
            }
        });
    }

    $('#simulation .exitBtn').click(function() {
        $('#simulation').hide();
    })

    // SIT importer
    var SIT = {
        get_all: function(url, callback, progress, _loaded) {
            _loaded = _loaded || 0;
            var all = [];
            $.get(url, function(data) {
                for (var i = 0; i < data.results.length; i++) all.push(data.results[i]);
                if (data.next) {
                    _loaded += all.length;
                    if (typeof progress === "function") progress(_loaded, data.count);

                    setTimeout(function() {
                        SIT.get_all(data.next, function(result) {
                            for (var i = 0; i < result.length; i++) all.push(result[i]);
                            callback(all);
                        }, progress, _loaded);
                    }, 10);
                } else {
                    callback(all);
                }
            });
        }
    };

    var SIT_user_name = localStorage.getItem('SIT_user_name');
    if (SIT_user_name != null) {
        $('#modalSIT input').val(SIT_user_name);
        SIT.get_all("//schoolido.lu/api/accounts/?owner__username=" + encodeURIComponent(SIT_user_name),
            function(accountList) {
                if (accountList.length === 0) {
                    alert("No SIT Accounts Found");
                    $("#modalSIT select").html('');
                }
                for (var i = 0; i < accountList.length; i++) {
                    $("#modalSIT select").append("<option value=\"" + accountList[i].id + "\">[" + accountList[i].language + "] " + accountList[i].nickname + "</select>");
                }
            });
    }

    $('#importSIT').click(function() {
        $('#modalSIT').show()
    })
    $('#modalSIT .exitBtn').click(function() {
        $('#modalSIT').hide()
    })
    $('#modalSIT input').change(function() {
        SIT_user_name = $(this).val()
        SIT.get_all("//schoolido.lu/api/accounts/?owner__username=" + encodeURIComponent(SIT_user_name),
            function(accountList) {
                if (accountList.length === 0) {
                    alert("No SIT Accounts Found");
                    $("#modalSIT select").html('');
                }
                for (var i = 0; i < accountList.length; i++) {
                    localStorage.setItem('SIT_user_name', SIT_user_name);
                    $("#modalSIT select").append("<option value=\"" + accountList[i].id + "\">[" + accountList[i].language + "] " + accountList[i].nickname + "</select>");
                }
            });

    })
    $('#modalSIT button').click(function() {
        var id = $("#modalSIT select").val();
        SIT.get_all("//schoolido.lu/api/ownedcards/?owner_account=" + encodeURIComponent(id) + "&stored=Deck&card__rarity=UR,SSR,SR,R&expand_card", function(cardList) {
            POST_JSON = {
                lang: 'EN',
                username: $("#modalSIT input").val(),
                account: $('#modalSIT option[value="{0}"]'.format(id)).text(),
                SIT_json: JSON.stringify(cardList),
                csrfmiddlewaretoken: '{{ csrf_token }}'
            }
            $.ajax({
                type: "POST",
                url: "SIT_convert",
                headers: {
                    'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
                },
                data: POST_JSON,
                success: function(data) {
                    if (data['complete']) {
                        user_json = data['user_json'];
                        localStorage.setItem('user_json', user_json);
                        $('#userJSON .profile').val(user_json);

                        user_json_bucket['auto save'] = user_json;
                        localStorage.setItem('user_json_bucket', JSON.stringify(user_json_bucket));

                        updateInfo(data['msg'], !data['complete']);
                        $('#modalSIT').hide()
                    } else {
                        alert('Import SIT account failed.')
                        updateInfo(data['msg'], !data['complete']);
                    }
                }
            });
        });
    })

    // Import local profile
    $('#profile-title').hover(function() {
        $('#profile-title b').text('Switch Local Profile')
        $('#profile-title b').css('color', 'rgb(0,255,0)')
    }, function() {
        $('#profile-title b').text('User JSON Profile')
        $('#profile-title b').css('color', 'white')
    })
    $('#profile-title').click(function() {
        $('#modalLocal').show();
        $("#modalLocal select").html('');
        for (var profle_name in user_json_bucket) {
            $("#modalLocal select").append("<option value=\"{0}\">{1}</select>".format(profle_name, profle_name));
        }
    })
    $('#modalLocal .exitBtn').click(function() {
        $('#modalLocal').hide()
    })
    $('#modalLocal .import').click(function() {
        var profile_name = $('#modalLocal select').val();
        user_json = user_json_bucket[profile_name];
        localStorage.setItem('user_json', user_json);
        $('#userJSON .profile').val(user_json);
        updateInfo('Successfully import the local profile [{0}].'.format(profile_name), false);
        $('#modalLocal').hide();
    })
    $('#modalLocal .save').click(function() {
        var profile_name = $('#modalLocal select').val();
        user_json_bucket[profile_name] = user_json;
        localStorage.setItem('user_json_bucket', JSON.stringify(user_json_bucket));
        updateInfo('Existing local profile [{0}] has been overwritten.'.format(profile_name), false);
        $('#modalLocal').hide();
    })
    $('#modalLocal .create').click(function() {
        var profile_name = prompt("Please give a name to local profile:", "auto save");
        if (profile_name == '') {
            alert('You must give an non-empty name!')
        } else {
            var valid = inputUserJSON()
            if (valid) {
                var existing = user_json_bucket[profile_name] == undefined;
                user_json_bucket[profile_name] = user_json;
                localStorage.setItem('user_json_bucket', JSON.stringify(user_json_bucket));

                if (existing) {
                    updateInfo('New local profile [{0}] has been created.'.format(profile_name), false);
                } else {
                    updateInfo('Existing local profile [{0}] has been overwritten.'.format(profile_name), false);
                }
            }
        }
        $('#modalLocal').hide();
    })
    </script>
</body>

</html>